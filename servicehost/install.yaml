- name: "Install Mathworks ServiceHost"
  hosts:
    - "puhti"
    - "mahti"
    - "lumi"
  become: false

  tasks:
    - name: "Include variables"
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/version/{{ version }}.yaml"

    - name: "Create Mathworks ServiceHost directory"
      ansible.builtin.file:
        path: "{{ appl_dir }}/{{ item }}"
        state: "directory"
        mode: "ug=rwx,o=rx,g+s"
        group: "{{ group }}"
      loop:
        - "mathworksservicehost"
        - "mathworksservicehost/{{ version }}"

    - name: "Download the mathworks servicehost"
      ansible.builtin.get_url:
        url: "https://ssd.mathworks.com/supportfiles/downloads/MathWorksServiceHost/v{{ version }}/release/glnxa64/managed_mathworksservicehost_{{ version }}_package_glnxa64.zip"
        dest: "{{ appl_dir }}/mathworksservicehost/{{ version }}.zip"
        checksum: "{{ checksum }}"
        mode: "ug=rw,o=r"
        group: "{{ group }}"

    - name: "Unzip the servicehost"
      ansible.builtin.unarchive:
        src: "{{ appl_dir }}/mathworksservicehost/{{ version }}.zip"
        dest: "{{ appl_dir }}/mathworksservicehost/{{ version }}"
        remote_src: true
        group: "{{ group }}"
        creates: "{{ appl_dir }}/mathworksservicehost/{{ version }}/bin"

    - name: "Write LatestInstall.info"
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/LatestInstall.info.j2"
        dest: "{{ appl_dir }}/mathworksservicehost/LatestInstall.info"
        group: "{{ group }}"

- name: "Synchronize across LUMI Lustres"
  hosts:
    - "lumi"
  become: false

  tasks:
    - name: "Create a matlab application directory"
      ansible.builtin.file:
        path: "{{ item }}"
        state: "directory"
        mode: "ug=rwx,o=rx,g+s"
        group: "{{ group }}"
      loop:
        - "/pfs/lustrep1/{{ appl_dir }}/mathworksservicehost"
        - "/pfs/lustrep3/{{ appl_dir }}/mathworksservicehost"
        - "/pfs/lustrep4/{{ appl_dir }}/mathworksservicehost"

    - name: "Synchronize installation"
      ansible.builtin.command: |
        rsync --archive --delete "{{ item.src }}" "{{ item.dest }}"
      loop:
        - src: "/pfs/lustrep2/{{ appl_dir }}/mathworksservicehost/{{ version }}"
          dest: "/pfs/lustrep1/{{ appl_dir }}/mathworksservicehost"
        - src: "/pfs/lustrep2/{{ appl_dir }}/mathworksservicehost/{{ version }}"
          dest: "/pfs/lustrep3/{{ appl_dir }}/mathworksservicehost"
        - src: "/pfs/lustrep2/{{ appl_dir }}/mathworksservicehost/{{ version }}"
          dest: "/pfs/lustrep4/{{ appl_dir }}/mathworksservicehost"
