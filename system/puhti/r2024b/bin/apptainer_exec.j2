#!/bin/bash

# Increase virtual memory to the hard limit (required on login nodes).
ulimit -v "$(ulimit -Hv)"

# Print directory if it exists
ifexists() { [ -d "$1" ] && echo "$1"; }

# Exec matlab container
apptainer --silent exec \
    --bind="/run/user" \
    --bind="/users,/projappl,/scratch,$TMPDIR,$LOCAL_SCRATCH,$(ifexists /fmi),$(ifexists /appl/data)" \
    --bind="/appl/soft/math/mathworksservicehost" \
    --env="MATHWORKS_SERVICE_HOST_MANAGED_INSTALL_ROOT=/appl/soft/math/mathworksservicehost" \
    --nv \
    "/appl/soft/math/matlab/mps/{{ version }}/matlab.sif" "$@"
